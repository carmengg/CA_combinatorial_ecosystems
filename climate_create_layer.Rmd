---
title: "climate_layer"
author: "Carmen Galaz-Garc√≠a"
output: html_document
---
```{r setup,  warning=FALSE, message=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(raster)
library(rgdal)
library(tidyverse)
library(here)
library(sf) 

library(tictoc)
```


```{r}
# ---- NOTES ABOUT FILES ----
# 2010 - 2019 decade folders only has files until 2018
#------------------------------------------------------------------------------

#----- generate file name
file_name <- function(tminmax,year,i){
  file <- paste("wc2.1_2.5m_",tminmax,"_",year,"-", sep="")
  if(i<10){
    file <- paste(file,'0',sep="")
  }
  file <- paste(file,i,".tif",sep="")
  return(file)
}

#----- generate folder name
folder_name <- function(tminmax,year){
  decade <- year - (year%%10)
  folder <- paste("wc2.1_2.5m_",tminmax,"_",decade,"-",decade+9,sep="")
  return(folder)
}
```


```{r}

#----- clipping and writing monthly rasters
# year = year to compute average temperature
# bbox = bounding box of area of interest
# returns the average of all (avg min monthly temps) and (avg max monthly temps) 
yearly_avg <- function(year,bbox){
  months <- stack()
  for(i in c(1:12)){
     month_rast <- raster(here("raw_data",
                               "world_clim_historical_monthly_data",
                               "min_avg_temp",
                               folder_name("tmin",year),
                               file_name("tmin",year,i)))
     month_rast <- crop(x= month_rast, y=bbox)
     months <- addLayer(months,month_rast)
  }
  for(i in c(1:12)){
     month_rast <- raster(here("raw_data",
                               "world_clim_historical_monthly_data",
                               "max_avg_temp",
                               folder_name("tmax",year),
                               file_name("tmax",year,i)))
     month_rast <- crop(x= month_rast, y=bbox)
     months <- addLayer(months,month_rast)
  }
  return(mean(months))
}

#------ create average over decade
# calculate avg temperature over 30 years before year
# ex: year= 2001, then average over [2000,1971]
thirty_year_avg <- function(year,bbox){
  years <- stack()
  for( i in c((year-30):(year-1))){
    years<- addLayer(years, yearly_avg(i,bbox))
  }
  return(mean(years))
}


```



# ---------------------------------------------------------------------------
# (-inf, 0) and every month avg<10: polar   (1)
# (-inf, 0): boreal                         (2)
#  [0,10) : cold temperate                  (3)
#  [10,18) : warm temperate                 (4)
#  [18,24) : subtropical                    (5)
#  [24,34) : tropical                       (6)

# temp_map = raster with average temperature (30 year avg)
temp_regions_1 <- function(temp_map){
  thresh<- matrix( c(-Inf, 0, 1, # this will be split into polar (1) and boreal (2)
                    0, 10 , 3,
                    10,18 , 4,
                    18,24 , 5,
                    24,43 , 6),
                   nrow=5,
                   byrow=TRUE) 
  # *** still need to separate polar and boreal ***
  # *** coming out of here category 1 = polar or boreal ***
  return(reclassify(temp_map,thresh, right=FALSE)) # a<= raster <b
}

# ---------------------------------------------------------------------------
# separate polar and boreal
# temp_regions = raster with temperature regions (codes 1-6)
# months_weather = raster stack with monthly average temperatures in 30 years(?)
separate_polar_boreal <- function(temp_regions, months_weather){
  polar_boreal <- temp_regions
  polar_boreal[polar_boreal!=1] <- NA

  months_boreal = polar_boreal*months_weather

  # choosing months with possible boreal regions (some month has avg temp>=10)
  drop <- c() # list of indices that need to be dropped
  k = length(months_boreal)
  for (i in 1:k){
    # if all temps on that month are <10, then cannot be boreal
    if(maxValue(months_boreal[[i]]) <10){ 
      drop <- c(drop,i)  
    }
  }
  # select months with pts in which avg temp is >=10
  months_boreal <- dropLayer(months_boreal, drop) 
  # select pts in the months with avg temp >=10
  boreal_region <- months_boreal >= 10
  # if more than one layer in months_boreal (maybe have to make NA into 0)
  #boreal_region <- sum(months_boreal)  
  #boreal_region[boreal_region>0] <- 1
  boreal_region[is.na(boreal_region) == TRUE] <- 0 # so you don't have NA + 0 adding the raster layers
  
  temp_regions <- temp_regions + boreal_region# original layer 1 + 1 = 2 (boreal)
  return(temp_regions)
}
```{r}



#writeRaster(temp_regions, filename=here("ca_subsets","avg_temp_30years","ca_30yr_temp_regions.tif"))
```

```{r}
# ---------------------------------------------------------------------------
# temp_map = raster with average temperature (30 year avg)
# path_months_weather = path to folder containing all month average 
temp_regions <- function(temp_map, path_months_weather){
  raster_files <-list.files(path = herepath_months_weather, 
                            full.names = TRUE)
  months_weather <- raster::stack(raster_files)
  return(separate_polar_boreal(temp_regions_1(temp_map),months_weater))
}

```


```{r}
#----- CA shapefile & bounding box ------
ca_shp <- readOGR(here("shapefiles",
                       "ca-state-boundary",
                       "CA_State_TIGER2016.shp"))
temp <- raster(here("raw_data","world_clim_historical_monthly_data",
                        "max_avg_temp",
                        "wc2.1_2.5m_tmax_1970-1979",
                         "wc2.1_2.5m_tmax_1970-01.tif"))
ca_shp <- spTransform(ca_shp, crs(temp))
rm(temp)

bbox <- st_bbox(ca_shp)

```

```{r, eval=FALSE}
# ---- test & timing  ---
tic("create 1 year avg")
year_avg_temp <- yearly_avg(year,bbox)
toc()  # ~4 sec


tic("decade avg")
temp_avg_2008 <- decade_avg(2008,bbox)
toc()  # ~2 min

```


```{r, eval=FALSE}
# ---- create climate rasters for 2001, 2008, 2019 -----

ca_clim_2001 <- mask(decade_avg(2001,bbox),ca_shp)
#writeRaster(ca_clim_2001, filename=here("ca_subsets","avg_temp_30years","ca_clim_2001.tif"))

ca_clim_2008 <- mask(decade_avg(2008,bbox),ca_shp)
#writeRaster(ca_clim_2008, filename=here("ca_subsets","avg_temp_30years","ca_clim_2008.tif"))

ca_clim_2019 <- mask(decade_avg(2019,bbox),ca_shp)
#writeRaster(ca_clim_2019, filename=here("ca_subsets","avg_temp_30years","ca_clim_2019.tif"))

```
