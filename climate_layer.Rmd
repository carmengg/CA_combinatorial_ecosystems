---
title: "climate_layer"
output: html_document
---
```{r}
library(raster)
library(rgdal)
library(tidyverse)
library(here)
library(sf) # simple features package (for shapefiles)

library(tictoc)
```


```{r}
temp <- raster(here("raw_data","world_clim_historical_monthly_data",
                        "max_avg_temp",
                        "wc2.1_2.5m_tmax_1970-1979",
                         "wc2.1_2.5m_tmax_1970-01.tif"))
#plot(temp)

#----- CA shapefile ------
ca_shp <- readOGR(here("shapefiles",
                       "ca-state-boundary",
                       "CA_State_TIGER2016.shp"))
ca_shp <- spTransform(ca_shp, crs(temp))

rm(temp)
```


```{r}
# ---- NOTES ABOUT FILES ----
# 2010 -2019 decade only has files until 2018

#----- generate file name
file_name <- function(tminmax,year,i){
  file <- paste("wc2.1_2.5m_",tminmax,"_",year,"-", sep="")
  if(i<10){
    file <- paste(file,'0',sep="")
  }
  file <- paste(file,i,".tif",sep="")
  return(file)
}

#----- generate folder name
folder_name <- function(tminmax,year){
  decade <- year - (year%%10)
  folder <- paste("wc2.1_2.5m_",tminmax,"_",decade,"-",decade+9,sep="")
  return(folder)
}


#----- clipping and writing monthly rasters
yearly_avg <- function(year,bbox){
  months <- stack()
  for(i in c(1:12)){
     month_rast <- raster(here("raw_data",
                               "world_clim_historical_monthly_data",
                               "min_avg_temp",
                               folder_name("tmin",year),
                               file_name("tmin",year,i)))
     month_rast <- crop(x= month_rast, y=bbox)
     months <- addLayer(months,month_rast)
  }
  for(i in c(1:12)){
     month_rast <- raster(here("raw_data",
                               "world_clim_historical_monthly_data",
                               "max_avg_temp",
                               folder_name("tmax",year),
                               file_name("tmax",year,i)))
     month_rast <- crop(x= month_rast, y=bbox)
     months <- addLayer(months,month_rast)
  }
  return(mean(months))
}

#------ create average over decade
# calculate avg temperature over 30 years before year
# ex: year= 2001, then average over [2000,1971]
decade_avg <- function(year,bbox){
  years <- stack()
  for( i in c((year-30):(year-1))){
    years<- addLayer(years, yearly_avg(i,bbox))
  }
  return(mean(years))
}


```


```{r}
bbox <- st_bbox(ca_shp)

#tic("create 1 year avg")
#year_avg_temp <- yearly_avg(year,bbox)
#toc()  # ~4 sec


tic("decade avg")
temp_avg_2008 <- decade_avg(2008,bbox)
toc()

ca_clim_2008 <- mask(temp_avg_2008,ca_shp)
plot(ca_clim_2008)
#writeRaster(ca_clim_2008, filename=here("ca_subsets","avg_temp_30years","ca_clim_2008.tif"))

temp_avg_2019 <- decade_avg(2019,bbox)
ca_clim_2019 <- mask(temp_avg_2019,ca_shp)
```

```{r}
year<-2019
for( i in c((year-30):(year-1))){
    for(j in c(1:12)){
      min_path <- here("raw_data","world_clim_historical_monthly_data","min_avg_temp",folder_name("tmin",i), file_name("tmin",i,j))
      max_path <- here("raw_data","world_clim_historical_monthly_data","max_avg_temp",folder_name("tmax",i), file_name("tmax",i,j))
      if(file.exists(min_path) == FALSE){
        print(file_name("tmin",i,j))
      }
      if(file.exists(max_path)==FALSE){
        print(file_name("tmax",i,j))
      }
    }
  }
```




