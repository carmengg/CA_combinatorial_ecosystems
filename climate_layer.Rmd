---
title: "climate_layer"
output: html_document
---
```{r}
library(raster)
library(rgdal)
library(tidyverse)
library(here)
library(sf) # simple features package (for shapefiles)

library(tictoc)
```


```{r}
temp <- raster(here("raw_data","world_clim_historical_monthly_data",
                        "max_avg_temp",
                        "wc2.1_2.5m_tmax_1970-1979",
                         "wc2.1_2.5m_tmax_1970-01.tif"))
#plot(temp)

#----- CA shapefile ------
ca_shp <- readOGR(here("shapefiles",
                       "ca-state-boundary",
                       "CA_State_TIGER2016.shp"))
ca_shp <- spTransform(ca_shp, crs(temp))

rm(temp)
```


```{r}
#----- generate file name
file_name <- function(tminmax,year,i){
  file <- paste("wc2.1_2.5m_",tminmax,"_",year,"-", sep="")
  if(i<10){
    file <- paste(file,'0',sep="")
  }
  file <- paste(file,i,".tif",sep="")
  return(file)
}

#----- generate folder name
folder_name <- function(tminmax,year){
  decade <- year - (year%%10)
  folder <- paste("wc2.1_2.5m_",tminmax,"_",decade,"-",decade+9,sep="")
  return(folder)
}


#----- clipping and writing monthly rasters
yearly_avg <- function(year,bbox){
  months <- stack()
  for(i in c(1:12)){
     month_rast <- raster(here("raw_data",
                               "world_clim_historical_monthly_data",
                               "min_avg_temp",
                               folder_name("tmin",year),
                               file_name("tmin",year,i)))
     month_rast <- crop(x= month_rast, y=bbox)
     months <- addLayer(months,month_rast)
  }
  for(i in c(1:12)){
     month_rast <- raster(here("raw_data",
                               "world_clim_historical_monthly_data",
                               "max_avg_temp",
                               folder_name("tmax",year),
                               file_name("tmax",year,i)))
     month_rast <- crop(x= month_rast, y=bbox)
     months <- addLayer(months,month_rast)
  }
  return(mean(months))
}

#------ create average over decade
# calculate avg temperature over 30 years before year
# ex: year= 2001, then average over [2000,1991,1990,1981,1980,1971]
decade_avg <- function(year,bbox){
  years <- stack()
  for( i in c((year-30):(year-1))){
    years<- addLayer(years, yearly_avg(i,bbox))
  }
  return(mean(years))
}

tic("decade avg")
decade_avg(2001,bbox)
toc()
```


```{r}
year<-2000
bbox <- st_bbox(ca_shp)
i <- 1

tic("create 1 year avg")
folder_name("tmin",year)
year_avg_temp <- yearly_avg(year,bbox)
toc()  # ~4 sec

```



```{r}
year<- 1970
months <- stack()
ca_bbox <- st_bbox(ca_shp)
for(i in c(1:12)){
   month_rast <- raster(here("raw_data",
                             "world_clim_historical_monthly_data",
                             "min_avg_temp",
                             folder_name("tmin",year),
                             file_name("tmin",year,i)))
   month_rast <- crop(x= month_rast, y=ca_bbox)
   months <- addLayer(months,month_rast)
}
mean(months)

```


